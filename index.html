<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‡è„‚æ‰“å¡ä¸­å¿ƒ</title>
<style>
    :root {
      color-scheme: light dark;
      font-family: "PingFang SC", "Microsoft YaHei", system-ui, -apple-system, sans-serif;
      --green: #38b48b;
      --orange: #ff9f45;
      --bg: #f6f8fb;
      --card: #ffffff;
      --shadow: 0 10px 40px rgba(0,0,0,0.08);
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      background: var(--bg);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 32px 16px 64px;
      color: #1d1d1f;
    }
    main {
      width: min(1080px, 100%);
    }
    header {
      margin-bottom: 24px;
    }
    h1 {
      margin: 0;
      font-size: clamp(28px, 4vw, 42px);
    }
    header p {
      margin: 8px 0 0;
      color: #555;
    }
    section {
      background: var(--card);
      border-radius: 18px;
      padding: 20px 24px 24px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
    }
    section h2 {
      margin: 0 0 12px;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    section p {
      margin: 6px 0;
      color: #666;
    }
    form {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    input,
    button,
    select {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 10px 14px;
      font-size: 15px;
      font-family: inherit;
      min-height: 44px;
    }
    input,
    select {
      flex: 1;
      min-width: 160px;
      background: #fff;
    }
    button {
      border: none;
      cursor: pointer;
      background: var(--green);
      color: #fff;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    button[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    button:hover:not([disabled]) {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(56, 180, 139, 0.3);
    }
    .field-group {
      flex: 1;
      min-width: 180px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    label {
      font-size: 13px;
      color: #4a5568;
    }
    .hint {
      font-size: 13px;
      color: #777;
      margin-top: 8px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 24px;
    }
    ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .todo-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: #f4f6fb;
    }
    .todo-item.completed {
      opacity: 0.6;
      text-decoration: line-through;
    }
    .todo-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
    .todo-actions {
      margin-left: auto;
      display: flex;
      gap: 6px;
    }
    .todo-actions button {
      background: transparent;
      border: none;
      color: #888;
      font-size: 14px;
      padding: 0 4px;
      min-height: auto;
      box-shadow: none;
    }
    .todo-actions button:hover {
      color: #111;
      transform: none;
    }
    #history-list {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .history-card {
      padding: 12px 16px;
      border-radius: 14px;
      background: #f4f6fb;
    }
    .history-card strong {
      color: #333;
    }
    .highlight {
      color: var(--orange);
    }
    .plan-preview {
      margin-top: 12px;
      background: #f4f6fb;
      border-radius: 14px;
      padding: 16px;
      font-size: 14px;
      color: #333;
      white-space: pre-wrap;
      max-height: 320px;
      overflow-y: auto;
    }
    .plan-preview.empty {
      color: #888;
    }
    @media (max-width: 640px) {
      section {
        padding: 18px;
      }
      form {
        flex-direction: column;
      }
      button {
        width: 100%;
      }
    }
</style>
</head>
<body>
  <main>
    <header>
      <h1>æˆ‘çš„å‡è„‚æ‰“å¡ä¸­å¿ƒ</h1>
      <p>è®°å½•ä½“é‡ã€è§„åˆ’æ¯æ—¥å¾…åŠï¼Œç»“åˆ AI å®šåˆ¶åŒ–æ–¹æ¡ˆï¼Œå¸®ä½ ç¨³ç¨³æ‹¿ä¸‹ç›®æ ‡èº«æã€‚</p>
      <p id="today-label"></p>
    </header>

    <section>
      <h2>ğŸ‘¤ åŸºç¡€ä¿¡æ¯</h2>
      <p>å¡«å¥½èµ„æ–™ååªä¿å­˜åœ¨å½“å‰æµè§ˆå™¨ï¼Œç”¨äºä¸ºä½ é‡èº«åˆ¶å®šè®¡åˆ’ã€‚</p>
      <form id="profile-form">
        <div class="field-group">
          <label for="profile-gender">æ€§åˆ«</label>
          <select id="profile-gender" required>
            <option value="">è¯·é€‰æ‹©</option>
            <option value="female">å¥³æ€§</option>
            <option value="male">ç”·æ€§</option>
            <option value="other">éäºŒå…ƒ/å…¶ä»–</option>
          </select>
        </div>
        <div class="field-group">
          <label for="profile-height">èº«é«˜ï¼ˆcmï¼‰</label>
          <input id="profile-height" type="number" min="120" max="220" placeholder="ä¾‹å¦‚ 168" required>
        </div>
        <div class="field-group">
          <label for="profile-weight">å½“å‰ä½“é‡ï¼ˆkgï¼‰</label>
          <input id="profile-weight" type="number" step="0.1" min="30" max="200" placeholder="ä¾‹å¦‚ 65.0" required>
        </div>
        <div class="field-group">
          <label for="profile-target">ç›®æ ‡ä½“é‡ï¼ˆkgï¼Œå¯é€‰ï¼‰</label>
          <input id="profile-target" type="number" step="0.1" min="30" max="200" placeholder="ä¾‹å¦‚ 55.0">
        </div>
        <div class="field-group">
          <label for="api-key">DeepSeek API Key</label>
          <input id="api-key" type="password" placeholder="ds-XXXX" autocomplete="off">
        </div>
        <button type="submit">ä¿å­˜åŸºç¡€ä¿¡æ¯</button>
      </form>
      <p id="profile-status" class="hint">ä¿¡æ¯ä»…å­˜å‚¨åœ¨æœ¬åœ°æµè§ˆå™¨ã€‚</p>
      <p class="hint">ï¼ˆè‹¥éœ€è°ƒç”¨ DeepSeek ç”Ÿæˆäººå·¥æ™ºèƒ½æ–¹æ¡ˆï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„ API Keyã€‚å¯éšæ—¶ç•™ç©ºï¼Œç³»ç»Ÿä¸ä¼šä¿å­˜ã€‚ï¼‰</p>
    </section>

    <section>
      <h2>ğŸ¯ æ¨¡å¼é€‰æ‹©</h2>
      <p>æ”¯æŒä¸‰ç§æ¨¡å¼ï¼ŒAI ä¼šæ ¹æ®æ¨¡å¼ç›®æ ‡ + ä½ çš„èº«ä½“æ•°æ®ç”Ÿæˆæ¯æ—¥å¾…åŠï¼ˆå«æ—©é¤/åˆé¤/æ™šé¤/æœ‰æ°§/æ— æ°§/ä¼‘æ¯ï¼‰ã€‚</p>
      <form id="mode-form">
        <div class="field-group">
          <label for="mode-select">é€‰æ‹©æ¨¡å¼</label>
          <select id="mode-select" required>
            <option value="">è‡ªç”±æ¨¡å¼ï¼ˆæ‰‹åŠ¨è§„åˆ’ï¼‰</option>
            <option value="quickBurn">æ¨¡å¼1 Â· å¿«é€Ÿç‡ƒè„‚ï¼ˆ14 å¤©å‡ 10kgï¼‰</option>
            <option value="healthy">æ¨¡å¼2 Â· å¥åº·å‡è„‚ï¼ˆæ¯å‘¨å‡ 2kgï¼‰</option>
            <option value="beauty">æ¨¡å¼3 Â· ä¸½äººå¡‘å½¢ï¼ˆæ¯å‘¨å‡ 1kgï¼‰</option>
          </select>
        </div>
        <button type="submit">ç”Ÿæˆæ¨¡å¼ä»£åŠ</button>
      </form>
      <p id="mode-status">å½“å‰ä¸ºè‡ªç”±æ¨¡å¼ï¼Œå¯è‡ªè¡Œæ·»åŠ å¾…åŠã€‚</p>
      <div id="plan-preview" class="plan-preview empty">è®¡åˆ’ç”Ÿæˆåä¼šå±•ç¤ºæœ€è¿‘å‡ å¤©çš„æ¦‚è¦ã€‚</div>
    </section>

    <div class="grid">
      <section>
        <h2>ğŸ“‹ ä»Šæ—¥å¾…åŠ</h2>
        <p>å…ˆåˆ—å‡ºä»Šå¤©å¿…åšäº‹é¡¹ï¼Œå®Œæˆåå‹¾é€‰å³å¯æ‰“å¡ã€‚</p>
        <form id="todo-form">
          <input id="todo-input" type="text" placeholder="ä¾‹å¦‚ï¼šæ—©é¤ 250ml è„±è„‚ç‰›å¥¶ + 40g ç‡•éº¦" required>
          <button type="submit">æ·»åŠ </button>
        </form>
        <ul id="todo-list"></ul>
      </section>

      <section>
        <h2>âš–ï¸ ä½“é‡è®°å½•</h2>
        <p>è¾“å…¥ä»Šæ—¥ä½“é‡ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä¿å­˜è¶‹åŠ¿ã€‚</p>
        <form id="weight-form">
          <input id="weight-input" type="number" step="0.1" min="30" max="200" placeholder="å•ä½ï¼škg" required>
          <button type="submit">è®°å½•ä½“é‡</button>
        </form>
        <p id="weight-status">ä»Šæ—¥å°šæœªè®°å½•ã€‚</p>
      </section>
    </div>

    <section>
      <h2>ğŸ“† è¿‘ä¸ƒæ—¥æ¦‚è§ˆ</h2>
      <div id="history-list"></div>
    </section>
  </main>

<script>
    const STORAGE_KEY = "fat-loss-logs";
    const CATEGORY_LABELS = {
      breakfast: "æ—©é¤",
      lunch: "åˆé¤",
      dinner: "æ™šé¤",
      cardio: "æœ‰æ°§è¿åŠ¨",
      strength: "æ— æ°§è¿åŠ¨",
      recovery: "ä¼‘æ¯ç¡çœ "
    };

    const todayLabel = document.getElementById("today-label");
    const todoForm = document.getElementById("todo-form");
    const todoInput = document.getElementById("todo-input");
    const todoList = document.getElementById("todo-list");
    const weightForm = document.getElementById("weight-form");
    const weightInputDaily = document.getElementById("weight-input");
    const weightStatus = document.getElementById("weight-status");
    const historyList = document.getElementById("history-list");
    const modeForm = document.getElementById("mode-form");
    const modeSelect = document.getElementById("mode-select");
    const modeStatus = document.getElementById("mode-status");
    const planPreview = document.getElementById("plan-preview");
    const profileForm = document.getElementById("profile-form");
    const genderSelect = document.getElementById("profile-gender");
    const profileHeight = document.getElementById("profile-height");
    const profileWeight = document.getElementById("profile-weight");
    const profileTarget = document.getElementById("profile-target");
    const profileStatus = document.getElementById("profile-status");
    const apiKeyInput = document.getElementById("api-key");

    const todayKey = new Date().toISOString().slice(0, 10);
    todayLabel.textContent = `ä»Šå¤©ï¼š${formatDateLabel(todayKey)}`;

    const MODE_CONFIGS = {
      quickBurn: {
        name: "æ¨¡å¼1 Â· å¿«é€Ÿç‡ƒè„‚ï¼ˆ14 å¤©å‡ 10kgï¼‰",
        duration: 14,
        description: "ä¸¤å‘¨å†…å¿«é€Ÿå‡é‡ 10kgï¼Œä¸¥æ ¼æ§åˆ¶ç¢³æ°´å’Œèƒ½é‡æ‘„å…¥ï¼Œå¹¶ç»“åˆé«˜é¢‘æœ‰æ°§ + æ— æ°§è®­ç»ƒã€‚",
        weeklyTarget: "æ¯å‘¨å‡é‡çº¦ 5kgï¼Œé‡ç‚¹ç»´æŒé«˜ä»£è°¢ä¸è‚Œè‚‰è´¨é‡ã€‚"
      },
      healthy: {
        name: "æ¨¡å¼2 Â· å¥åº·å‡è„‚ï¼ˆæ¯å‘¨å‡ 2kgï¼‰",
        duration: 28,
        description: "ä»¥å‡è¡¡è¥å…»å’Œç¨³æ­¥çƒ­é‡èµ¤å­—ä¸ºä¸»ï¼Œé€‚åˆé•¿æœŸåšæŒï¼Œå…¼é¡¾å¥åº·ä¸æ•ˆç‡ã€‚",
        weeklyTarget: "æ¯å‘¨å‡é‡ 2kgï¼Œå‘¨æœŸ 4 å‘¨ã€‚"
      },
      beauty: {
        name: "æ¨¡å¼3 Â· ä¸½äººå¡‘å½¢ï¼ˆæ¯å‘¨å‡ 1kgï¼‰",
        duration: 42,
        description: "å¼ºè°ƒçº¿æ¡é›•åˆ»ä¸ä½“æ€ç®¡ç†ï¼Œä½å†²å‡»è®­ç»ƒç»“åˆé«˜è›‹ç™½é¥®é£Ÿï¼Œå¾ªåºæ¸è¿›ã€‚",
        weeklyTarget: "æ¯å‘¨å‡é‡ 1kgï¼Œå¯æŒç»­ 6 å‘¨ã€‚"
      }
    };

    const SYSTEM_PROMPT = "ä½ æ˜¯ä¸€åä¸“ä¸šçš„å¥èº«ä¸è¥å…»æŒ‡å¯¼ AIï¼Œéœ€è¦æ ¹æ®ç”¨æˆ·èº«ä½“æ•°æ®ä¸ç›®æ ‡åˆ¶å®šå¯æ‰§è¡Œçš„æ¯æ—¥è®¡åˆ’ã€‚åŠ¡å¿…ç¡®ä¿æ‰€æœ‰ä»»åŠ¡å…·å¤‡é‡åŒ–æŒ‡æ ‡ï¼Œå¹¶è¦†ç›–æ—©é¤ã€åˆé¤ã€æ™šé¤ã€æœ‰æ°§è¿åŠ¨ã€æ— æ°§è¿åŠ¨ã€ä¼‘æ¯ç¡çœ å…­å¤§ç±»åˆ«ã€‚";

    function loadData() {
      try {
        return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
      } catch {
        return {};
      }
    }

    function saveData(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function getMeta() {
      const data = loadData();
      return data._meta || {};
    }

    function saveMeta(patch) {
      const data = loadData();
      data._meta = { ...(data._meta || {}), ...patch };
      saveData(data);
    }

    function getProfile() {
      const meta = getMeta();
      return meta.profile || { gender: "", height: "", weight: "", target: "" };
    }

    function ensureDay(data, day) {
      if (!data[day]) {
        data[day] = { todos: [], weight: "" };
      }
    }

    function createTodo(text) {
      return {
        id: typeof crypto !== "undefined" && crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(),
        text,
        done: false
      };
    }

    function getDateKeys(data) {
      return Object.keys(data).filter(key => /^\d{4}-\d{2}-\d{2}$/.test(key));
    }

    function renderDay() {
      const data = loadData();
      ensureDay(data, todayKey);

      todoList.innerHTML = "";
      data[todayKey].todos.forEach(todo => {
        const li = document.createElement("li");
        li.className = `todo-item ${todo.done ? "completed" : ""}`;

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = todo.done;
        checkbox.addEventListener("change", () => toggleTodo(todo.id));

        const span = document.createElement("span");
        span.textContent = todo.text;

        const actions = document.createElement("div");
        actions.className = "todo-actions";

        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.textContent = "åˆ é™¤";
        delBtn.addEventListener("click", () => deleteTodo(todo.id));

        actions.appendChild(delBtn);

        li.appendChild(checkbox);
        li.appendChild(span);
        li.appendChild(actions);
        todoList.appendChild(li);
      });

      const weight = data[todayKey].weight;
      weightStatus.textContent = weight ? `ä»Šæ—¥ä½“é‡ï¼š${weight} kg` : "ä»Šæ—¥å°šæœªè®°å½•ã€‚";
      weightInputDaily.value = weight || "";

      renderHistory(data);
      refreshModeStatus();
      refreshPlanPreview();
    }

    function addTodo(text) {
      const data = loadData();
      ensureDay(data, todayKey);
      data[todayKey].todos.push(createTodo(text));
      saveData(data);
      renderDay();
    }

    function toggleTodo(id) {
      const data = loadData();
      ensureDay(data, todayKey);
      data[todayKey].todos = data[todayKey].todos.map(todo =>
        todo.id === id ? { ...todo, done: !todo.done } : todo
      );
      saveData(data);
      renderDay();
    }

    function deleteTodo(id) {
      const data = loadData();
      ensureDay(data, todayKey);
      data[todayKey].todos = data[todayKey].todos.filter(todo => todo.id !== id);
      saveData(data);
      renderDay();
    }

    function saveWeight(value) {
      const data = loadData();
      ensureDay(data, todayKey);
      data[todayKey].weight = value;
      saveData(data);
      renderDay();
    }

    function renderHistory(data) {
      const days = getDateKeys(data).sort((a, b) => b.localeCompare(a)).slice(0, 7);
      historyList.innerHTML = "";
      if (days.length === 0) {
        historyList.innerHTML = "<p>æš‚æ— å†å²è®°å½•ï¼Œä»Šå¤©å°±å¼€å§‹å§ï¼</p>";
        return;
      }

      days.forEach(day => {
        const { todos, weight } = data[day];
        const finished = todos.filter(todo => todo.done).length;
        const card = document.createElement("div");
        card.className = "history-card";
        card.innerHTML = `
          <strong>${formatDateLabel(day)}</strong>
          <p>ä½“é‡ï¼š${weight ? `<span class="highlight">${weight} kg</span>` : "æœªè®°å½•"}</p>
          <p>å¾…åŠå®Œæˆï¼š${finished}/${todos.length || 1}</p>
        `;
        historyList.appendChild(card);
      });
    }

    function formatDateLabel(dateStr) {
      const date = new Date(dateStr);
      return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ï¼ˆå‘¨${"æ—¥ä¸€äºŒä¸‰å››äº”å…­"[date.getDay()]}ï¼‰`;
  }

    function refreshModeStatus() {
      const meta = getMeta();
      if (meta.lastMode) {
        const { name, generatedAt, duration } = meta.lastMode;
        const time = new Date(generatedAt).toLocaleString();
        modeStatus.textContent = `å·²å¯ç”¨ ${name}ï¼Œç”Ÿæˆäº ${time}ï¼Œè¦†ç›– ${duration} å¤©è®¡åˆ’ã€‚`;
      } else {
        modeStatus.textContent = "å½“å‰ä¸ºè‡ªç”±æ¨¡å¼ï¼Œå¯è‡ªè¡Œæ·»åŠ å¾…åŠã€‚";
      }
    }

    function refreshPlanPreview() {
      const meta = getMeta();
      if (meta.lastMode?.preview) {
        planPreview.textContent = meta.lastMode.preview;
        planPreview.classList.remove("empty");
      } else {
        planPreview.textContent = "è®¡åˆ’ç”Ÿæˆåä¼šå±•ç¤ºæœ€è¿‘å‡ å¤©çš„æ¦‚è¦ã€‚";
        planPreview.classList.add("empty");
      }
    }

    todoForm.addEventListener("submit", (event) => {
      event.preventDefault();
      const value = todoInput.value.trim();
      if (!value) return;
      addTodo(value);
      todoInput.value = "";
      todoInput.focus();
    });

    weightForm.addEventListener("submit", (event) => {
      event.preventDefault();
      const value = parseFloat(weightInputDaily.value);
      if (Number.isNaN(value)) return;
      saveWeight(value.toFixed(1));
    });

    profileForm.addEventListener("submit", (event) => {
      event.preventDefault();
      if (!profileForm.checkValidity()) {
        profileStatus.textContent = "è¯·å®Œæ•´å¡«å†™å¿…å¡«ä¿¡æ¯ã€‚";
        return;
      }
      const profile = collectProfileFromForm();
      saveMeta({ profile });
      profileStatus.textContent = "åŸºç¡€ä¿¡æ¯å·²ä¿å­˜ï¼ˆä»…ä¿å­˜åœ¨æœ¬åœ°ï¼‰ã€‚";
      setTimeout(() => refreshModeStatus(), 300);
    });

    modeForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!modeSelect.value) {
        modeStatus.textContent = "å½“å‰ä¸ºè‡ªç”±æ¨¡å¼ï¼Œå¯è‡ªè¡Œæ·»åŠ å¾…åŠã€‚";
        return;
      }
      const profile = collectProfileFromForm();
      if (!profile.gender || !profile.height || !profile.weight) {
        modeStatus.textContent = "è¯·å…ˆä¿å­˜å®Œæ•´çš„åŸºç¡€ä¿¡æ¯ã€‚";
        return;
      }
      const apiKey = apiKeyInput.value.trim();
      if (!apiKey) {
        modeStatus.textContent = "è¯·å¡«å†™ DeepSeek API Keyï¼Œæ‰èƒ½è°ƒç”¨ AI ç”Ÿæˆè®¡åˆ’ã€‚";
        return;
      }
      await generateModePlan(modeSelect.value, profile, apiKey);
    });

    function collectProfileFromForm() {
      return {
        gender: genderSelect.value,
        height: Number(profileHeight.value || 0),
        weight: Number(profileWeight.value || 0),
        target: profileTarget.value ? Number(profileTarget.value) : ""
      };
    }

    function populateProfileForm() {
      const profile = getProfile();
      if (profile.gender) genderSelect.value = profile.gender;
      if (profile.height) profileHeight.value = profile.height;
      if (profile.weight) profileWeight.value = profile.weight;
      if (profile.target) profileTarget.value = profile.target;
    }

    async function generateModePlan(modeKey, profile, apiKey) {
      const config = MODE_CONFIGS[modeKey];
      if (!config) return;
      modeForm.querySelector("button[type='submit']").disabled = true;
      modeStatus.textContent = `æ­£åœ¨ä¸ºä½ è°ƒç”¨ DeepSeekï¼Œç”Ÿæˆ ${config.name} è®¡åˆ’â€¦`;
      try {
        const plan = await callChatGPT(config, profile, apiKey);
        applyPlan(plan);
        const previewText = plan.dailyTasks
          .slice(0, 3)
          .map(day => {
            const items = day.tasks
              .map(task => `Â· [${CATEGORY_LABELS[task.category] || task.category}] ${task.text}ï¼ˆæŒ‡æ ‡ï¼š${task.metric}ï¼‰`)
              .join("\n");
            return `${day.title}\n${items}`;
          })
          .join("\n\n");
        saveMeta({
          lastMode: {
            name: config.name,
            duration: plan.duration,
            generatedAt: new Date().toISOString(),
            preview: previewText,
            profile
          }
        });
        planPreview.textContent = previewText;
        planPreview.classList.remove("empty");
        modeStatus.textContent = `å·²ç”Ÿæˆ ${config.name}ï¼Œè¦†ç›– ${plan.duration} å¤©ï¼Œå·²å†™å…¥å¾…åŠã€‚`;
        apiKeyInput.value = "";
        profileStatus.textContent = "å·²åŸºäºå½“å‰åŸºç¡€ä¿¡æ¯ç”Ÿæˆæ¨¡å¼è®¡åˆ’ã€‚";
      } catch (error) {
        console.error(error);
        modeStatus.textContent = `ç”Ÿæˆå¤±è´¥ï¼š${error.message}`;
      } finally {
        modeForm.querySelector("button[type='submit']").disabled = false;
        renderDay();
      }
    }

    const MODEL_ENDPOINT = {
      url: "https://api.deepseek.com/v1/chat/completions",
      model: "deepseek-chat"
    };

    async function callChatGPT(config, profile, apiKey) {
      const prompt = buildPlanPrompt(config, profile);
      const response = await fetch(MODEL_ENDPOINT.url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: MODEL_ENDPOINT.model,
          temperature: 0.7,
          messages: [
            { role: "system", content: SYSTEM_PROMPT },
            { role: "user", content: prompt }
          ]
        })
      });

      const result = await response.json();
      if (!response.ok) {
        throw new Error(result.error?.message || "DeepSeek æ¥å£è¿”å›é”™è¯¯");
      }
      const content = result.choices?.[0]?.message?.content?.trim();
      if (!content) {
        throw new Error("æœªæ”¶åˆ°æœ‰æ•ˆçš„è®¡åˆ’å†…å®¹");
      }
      const cleanJson = stripJsonFence(content);
      return JSON.parse(cleanJson);
    }

    function buildPlanPrompt(config, profile) {
      return `
è¯·ç”Ÿæˆ ${config.duration} å¤©çš„æ¯æ—¥è®¡åˆ’ï¼Œæ¨¡å¼è¯´æ˜ï¼š${config.description}ã€‚ç”¨æˆ·æ•°æ®å¦‚ä¸‹ï¼š
- æ€§åˆ«ï¼š${profile.gender}
- èº«é«˜ï¼š${profile.height} cm
- å½“å‰ä½“é‡ï¼š${profile.weight} kg
- ç›®æ ‡ä½“é‡ï¼š${profile.target || "æœªå¡«å†™"}
- æ¨¡å¼ç›®æ ‡ï¼š${config.weeklyTarget}

è¦æ±‚ï¼š
1. æ¯å¤©å¿…é¡»åŒ…å«æ—©é¤ã€åˆé¤ã€æ™šé¤ã€æœ‰æ°§è¿åŠ¨ã€æ— æ°§è¿åŠ¨ã€ä¼‘æ¯ç¡çœ å…± 6 æ¡ä»»åŠ¡ã€‚
2. æ¯é¡¹ä»»åŠ¡éƒ½è¦ç»™å‡ºæ˜ç¡®çš„é‡åŒ–æ•°å­—ï¼ˆå…‹æ•°ã€æ¯«å‡ã€åˆ†é’Ÿã€å¿ƒç‡åŒºé—´ã€ç»„æ•°ç­‰ï¼‰ã€‚
3. æ§åˆ¶çƒ­é‡ä¸è®­ç»ƒå¼ºåº¦ç¬¦åˆæ¨¡å¼ç›®æ ‡ï¼Œæ³¨æ„ä¸åŒæ€§åˆ«ã€BMI å¯¹èƒ½é‡æ‘„å…¥çš„å½±å“ã€‚
4. è¾“å‡ºä¸¥æ ¼ JSONï¼ˆUTF-8ï¼‰ï¼Œä¸åŒ…å«ä»»ä½•é¢å¤–æ–‡å­—ï¼Œç»“æ„å¦‚ä¸‹ï¼š
{
  "planName": "å­—ç¬¦ä¸²",
  "duration": æ•°å­—,
  "notes": "æ€»ä½“è¯´æ˜",
  "dailyTasks": [
    {
      "day": 1,
      "title": "ç¬¬1å¤©æ ‡é¢˜",
      "tasks": [
        { "category": "breakfast", "text": "æè¿°", "metric": "é‡åŒ–æŒ‡æ ‡" },
        { "category": "lunch", "text": "...", "metric": "..." },
        { "category": "dinner", "text": "...", "metric": "..." },
        { "category": "cardio", "text": "...", "metric": "..." },
        { "category": "strength", "text": "...", "metric": "..." },
        { "category": "recovery", "text": "...", "metric": "..." }
      ]
    },
    ...
  ]
}
åŠ¡å¿…è¿”å›åˆæ³• JSONã€‚`;
    }

    function stripJsonFence(text) {
      if (text.startsWith("```")) {
        return text.replace(/```json|```/g, "").trim();
      }
      return text;
    }

    function applyPlan(plan) {
      const data = loadData();
      const startDate = new Date();
      plan.dailyTasks.forEach((dayPlan, index) => {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + index);
        const key = date.toISOString().slice(0, 10);
        const todos = dayPlan.tasks.map(task => {
          const label = CATEGORY_LABELS[task.category] || task.category;
          const metric = task.metric ? `ï¼ˆæŒ‡æ ‡ï¼š${task.metric}ï¼‰` : "";
          return createTodo(`[${label}] ${task.text}${metric}`);
        });
        data[key] = {
          ...data[key],
          todos,
          weight: data[key]?.weight || ""
        };
      });
      saveData(data);
    }

    populateProfileForm();
    renderDay();
</script>
</body>
</html>
